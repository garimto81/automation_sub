# PRD-0007 Part 1: Overview

## 1. 목적

WSOP 방송 그래픽 자막 시스템의 데이터베이스를 **4개 분리 스키마**로 재설계하여:

1. **데이터 소스별 독립적 관리** - 각 소스의 특성에 맞는 테이블 구조
2. **업데이트 주기 분리** - 실시간, 배치, 수동 데이터의 독립적 처리
3. **권한 세분화** - 스키마별 RLS 정책 적용
4. **확장성 확보** - 새 데이터 소스 추가 시 스키마 추가로 대응

---

## 2. 범위

### 포함

| 항목 | 설명 |
|------|------|
| 4개 스키마 설계 | ae, json, wsop_plus, manual |
| 25개 테이블 정의 | 각 스키마별 테이블 구조 |
| 크로스 스키마 관계 | Soft FK, 공유 뷰 |
| RLS 정책 | 스키마별 권한 설정 |
| Migration 파일 | Supabase 적용 가능한 SQL |

### 제외

| 항목 | 사유 |
|------|------|
| 렌더링 파이프라인 | PRD-0001에서 정의 |
| API 엔드포인트 상세 | 별도 API 설계 문서 |
| 프론트엔드 UI | 별도 UI 설계 문서 |

---

## 3. 스키마 분리 전략

### 3.1 분리 기준

```
데이터 소스 × 업데이트 주기 = 스키마
```

| 스키마 | 데이터 소스 | 업데이트 주기 | 특성 |
|--------|------------|--------------|------|
| **ae** | AEP 파일 분석 | On-demand | 템플릿 메타데이터, 정적 |
| **json** | pokerGFX RFID | ~1초 | 실시간 핸드 데이터 |
| **wsop_plus** | WSOP+ CSV | 배치/이벤트 | 토너먼트 운영 데이터 |
| **manual** | 운영팀 입력 | 수동 | 마스터 데이터 |

### 3.2 분리 이점

```
기존 (단일 wsop 스키마)
┌─────────────────────────────────┐
│           wsop                  │
│  21개 테이블 (혼재)              │
│  - 실시간 + 배치 + 수동 혼합     │
│  - 단일 RLS 정책                │
│  - 복잡한 의존성                 │
└─────────────────────────────────┘

신규 (4개 분리 스키마)
┌─────────┐ ┌─────────┐ ┌───────────┐ ┌─────────┐
│   ae    │ │  json   │ │ wsop_plus │ │ manual  │
│ 7 tables│ │ 6 tables│ │ 5 tables  │ │ 7 tables│
│ 정적    │ │ 실시간  │ │ 배치      │ │ 수동    │
│ 독립RLS │ │ 독립RLS │ │ 독립RLS   │ │ 독립RLS │
└────┬────┘ └────┬────┘ └─────┬─────┘ └────┬────┘
     │           │            │            │
     └───────────┴─────┬──────┴────────────┘
                       │
              Soft FK / 공유 뷰
```

---

## 4. 기존 PRD와의 관계

### 4.1 PRD-0004 (Caption DB Schema) 대체

| PRD-0004 | PRD-0007 | 변경 |
|----------|----------|------|
| wsop 단일 스키마 | 4개 분리 스키마 | 분리 |
| 21개 테이블 | 25개 테이블 | +4개 |
| Hard FK | Soft FK + 뷰 | 유연성 |

### 4.2 PRD-0006 (AEP Data Elements) 연계

PRD-0006의 AEP 레이어 → DB 필드 매핑을 **ae.layer_data_mappings** 테이블로 구현

```
PRD-0006 정의          →  PRD-0007 구현
─────────────────────────────────────────
AEP 동적 레이어        →  ae.composition_layers
레이어-필드 매핑       →  ae.layer_data_mappings
데이터 소스 (json)     →  json.* 테이블
데이터 소스 (wsop+)    →  wsop_plus.* 테이블
데이터 소스 (manual)   →  manual.* 테이블
```

---

## 5. 용어 정의

| 용어 | 정의 |
|------|------|
| **Soft FK** | 외래 키 제약 조건 없이 UUID로 참조하는 방식 |
| **Hard FK** | REFERENCES 제약 조건이 있는 외래 키 |
| **Cross-Schema View** | 여러 스키마의 테이블을 조인하는 뷰 |
| **GFX Session** | pokerGFX JSON 파일 하나에 해당하는 세션 |
| **Hand** | 포커 한 핸드 (딜링~승자 결정) |
| **Player Instance** | 특정 토너먼트에 참가한 플레이어 인스턴스 |
| **Player Master** | 플레이어 마스터 레코드 (토너먼트 무관) |

---

## 6. 목표

### 필수 목표 (Must Have)

- [ ] 4개 스키마 생성 및 권한 설정
- [ ] 25개 테이블 생성 (인덱스 포함)
- [ ] 자동 업데이트 트리거 설정
- [ ] RLS 정책 활성화
- [ ] 크로스 스키마 뷰 생성

### 권장 목표 (Should Have)

- [ ] 데이터 검증 함수
- [ ] 실시간 구독 (Realtime) 설정
- [ ] 성능 최적화 인덱스

### 선택 목표 (Nice to Have)

- [ ] 데이터 품질 대시보드
- [ ] 자동 데이터 동기화 함수

---

## 7. 비목표 (Non-Goals)

| 항목 | 사유 |
|------|------|
| 기존 wsop 스키마 마이그레이션 | 새 프로젝트로 시작 |
| 프론트엔드 구현 | 별도 프로젝트 |
| API 구현 | 별도 백엔드 프로젝트 |
| 렌더링 파이프라인 | PRD-0001 범위 |

---

## 8. 성공 기준

| 기준 | 측정 방법 |
|------|----------|
| 스키마 생성 완료 | `SELECT schema_name FROM information_schema.schemata` |
| 테이블 25개 생성 | 스키마별 테이블 카운트 |
| RLS 활성화 | `pg_tables.rowsecurity = TRUE` |
| 인덱스 생성 | `pg_indexes` 조회 |
| 트리거 동작 | `updated_at` 자동 갱신 확인 |

---

## 다음 파트

→ [Part 2: Schema Architecture](02-schema-architecture.md)
